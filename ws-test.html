<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drone Map</title>
    
    <!-- Leaflet CSS for map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .main-content {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        #sidebar {
            width: 320px;
            background: #ecf0f1;
            overflow-y: auto;
            padding: 15px;
            border-right: 2px solid #bdc3c7;
        }

        .sidebar-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .drone-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s;
        }

        .drone-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transform: translateY(-2px);
        }

        .drone-card-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            font-size: 16px;
            font-weight: bold;
            color: #2c3e50;
        }

        .drone-icon {
            font-size: 24px;
            margin-right: 10px;
        }

        .drone-card-data {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            font-size: 13px;
        }

        .data-item {
            display: flex;
            flex-direction: column;
        }

        .data-label {
            color: #7f8c8d;
            font-size: 11px;
        }

        .data-value {
            color: #2c3e50;
            font-weight: bold;
        }

        #info {
            background: #2c3e50;
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
        }

        .info-label {
            font-size: 12px;
            color: #95a5a6;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 20px;
            font-weight: bold;
        }

        .status {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
        }

        .connected {
            background: #27ae60;
        }

        .disconnected {
            background: #e74c3c;
        }

        #map {
            flex: 1;
        }
    </style>
</head>
<body>
    <!-- Top bar showing connection status -->
    <div id="info">
        <div class="info-item">
            <span class="info-label">Status</span>
            <span class="status disconnected" id="status">Disconnected</span>
        </div>
        <div class="info-item">
            <span class="info-label">Total Drones</span>
            <span class="info-value" id="totalDrones">0</span>
        </div>
    </div>

    <!-- Main content with sidebar and map -->
    <div class="main-content">
        <!-- Sidebar with drone cards -->
        <div id="sidebar">
            <div class="sidebar-title">üì° Drones List</div>
            <div id="droneCards">
                <p style="color: #7f8c8d; text-align: center;">No drones detected</p>
            </div>
        </div>

        <!-- Map container -->
        <div id="map"></div>
    </div>

    <!-- Leaflet JS for map -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // Create the map (centered on drone area - Bangkok area)
        const map = L.map('map').setView([13.7563, 100.5016], 16);
        
        // Add map tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap'
        }).addTo(map);

        // Store drones data
        const drones = {};
        const droneMarkers = {};
        const droneColors = {};

        // Colors for different drones
        const colors = ['#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c'];
        let colorIndex = 0;

        // Get color for drone
        function getDroneColor(droneId) {
            if (!droneColors[droneId]) {
                droneColors[droneId] = colors[colorIndex % colors.length];
                colorIndex++;
            }
            return droneColors[droneId];
        }

        // Connect to WebSocket
        // Change 'localhost' to your IP (like '192.168.1.104') if needed
        const ws = new WebSocket('ws://localhost:3000/ws');

        // Update status display
        function updateStatus(isConnected) {
            const statusEl = document.getElementById('status');
            if (isConnected) {
                statusEl.textContent = 'Connected';
                statusEl.className = 'status connected';
            } else {
                statusEl.textContent = 'Disconnected';
                statusEl.className = 'status disconnected';
            }
        }

        // Create or update object card in sidebar (new structure)
        function updateObjectCard(objectData) {
            const cardId = `card-${objectData.obj_id}`;
            let card = document.getElementById(cardId);

            if (!card) {
                // Create new card
                card = document.createElement('div');
                card.id = cardId;
                card.className = 'drone-card';
                card.onclick = () => {
                    // Focus map on this object
                    map.setView([objectData.lat, objectData.lng], 17);
                    droneMarkers[objectData.obj_id].openPopup();
                };
                document.getElementById('droneCards').appendChild(card);
            }

            // Update card content
            const time = new Date(objectData.timestamp).toLocaleTimeString();
            const type = objectData.type || 'Unknown';
            const camId = objectData.cam_id || 'Unknown';
            const cameraName = objectData.camera_info?.name || 'N/A';
            
            card.innerHTML = `
                <div class="drone-card-header">
                    <span class="drone-icon">‚úàÔ∏è</span>
                    <span>${objectData.obj_id}</span>
                </div>
                <div class="drone-card-data">
                    <div class="data-item">
                        <span class="data-label">Type</span>
                        <span class="data-value">${type}</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Height</span>
                        <span class="data-value">${objectData.alt.toFixed(1)} m</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Speed</span>
                        <span class="data-value">${objectData.speed_kt.toFixed(2)} kt</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Speed (m/s)</span>
                        <span class="data-value">${objectData.speed_mps.toFixed(2)}</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Camera ID</span>
                        <span class="data-value">${camId}</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Location</span>
                        <span class="data-value">${cameraName}</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Latitude</span>
                        <span class="data-value">${objectData.lat.toFixed(6)}</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Longitude</span>
                        <span class="data-value">${objectData.lng.toFixed(6)}</span>
                    </div>
                    <div class="data-item" style="grid-column: 1 / -1;">
                        <span class="data-label">Last Update</span>
                        <span class="data-value">${time}</span>
                    </div>
                </div>
            `;

            // Update total objects count
            document.getElementById('totalDrones').textContent = Object.keys(drones).length;
        }

        // Remove "no drones" message
        function removeNoDataMessage() {
            const cardsContainer = document.getElementById('droneCards');
            const noDataMsg = cardsContainer.querySelector('p');
            if (noDataMsg) {
                noDataMsg.remove();
            }
        }

        // When WebSocket opens
        ws.onopen = () => {
            console.log('Connected to WebSocket');
            updateStatus(true);
        };

        // When WebSocket closes
        ws.onclose = () => {
            console.log('Disconnected from WebSocket');
            updateStatus(false);
        };

        // When WebSocket has error
        ws.onerror = (error) => {
            console.error('WebSocket error:', error);
            updateStatus(false);
        };

        // When message arrives
        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            console.log('Received:', data);

            if (data.type === 'hello') {
                console.log('Server said hello!');
            } 
            else if (data.fram_id && data.objects) {
                // New frame structure with objects
                const frame = data;
                
                // Process each object in the frame
                frame.objects.forEach((obj) => {
                    const objId = obj.obj_id;
                    
                    // Convert speed from knots to m/s for display (1 knot = 0.514444 m/s)
                    const speedMps = obj.speed_kt * 0.514444;
                    
                    // Create object data structure for display
                    const objectData = {
                        obj_id: objId,
                        type: obj.type || 'Unknown',
                        lat: obj.lat,
                        lng: obj.lng,
                        alt: obj.alt,
                        speed_kt: obj.speed_kt,
                        speed_mps: speedMps,
                        timestamp: frame.timestamp,
                        cam_id: frame.cam_id,
                        camera_info: frame.token_id?.camera_info || {},
                    };

                    // Store object data
                    drones[objId] = objectData;

                    // Remove "no drones" message if this is the first object
                    removeNoDataMessage();

                    // Update object card in sidebar
                    updateObjectCard(objectData);

                    // Update or create object marker on map
                    const popupContent = `
                        <b>${objId}</b><br>
                        Type: ${obj.type || 'Unknown'}<br>
                        Height: ${obj.alt.toFixed(2)}m<br>
                        Speed: ${obj.speed_kt.toFixed(2)} kt (${speedMps.toFixed(2)} m/s)<br>
                        Camera: ${frame.cam_id}<br>
                        ${frame.token_id?.camera_info?.name ? `Location: ${frame.token_id.camera_info.name}<br>` : ''}
                        Frame: ${frame.fram_id}
                    `;
                    
                    if (droneMarkers[objId]) {
                        // Move existing marker
                        droneMarkers[objId].setLatLng([obj.lat, obj.lng]);
                        droneMarkers[objId].setPopupContent(popupContent);
                    } else {
                        // Create new marker with unique color
                        const color = getDroneColor(objId);
                        const icon = L.divIcon({
                            className: 'drone-marker',
                            html: `<div style="background: ${color}; width: 40px; height: 40px; border-radius: 50%; border: 4px solid white; box-shadow: 0 3px 15px rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; font-size: 24px;">‚úàÔ∏è</div>`,
                            iconSize: [40, 40],
                            iconAnchor: [20, 20]
                        });
                        
                        droneMarkers[objId] = L.marker([obj.lat, obj.lng], { icon: icon })
                            .addTo(map)
                            .bindPopup(popupContent);
                    }
                });

                // Center map on first object only
                if (Object.keys(drones).length === 1 && frame.objects.length > 0) {
                    const firstObj = frame.objects[0];
                    map.setView([firstObj.lat, firstObj.lng], 16);
                }
            }
        };
    </script>
</body>
</html>

